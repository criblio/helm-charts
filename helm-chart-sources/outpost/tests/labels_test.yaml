suite: Labels
templates:
  - deployment.yaml
  - service.yaml
  - serviceaccount.yaml
tests:
  - it: Should set default labels on deployment
    set:
      cribl.leader: tcp://token@leader:4200
    template: deployment.yaml
    release:
      name: test-release
    chart:
      name: outpost
      version: 1.0.0
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: outpost
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-release
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: outpost-1.0.0
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: outpost
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: test-release

  - it: Should add extra labels to deployment
    set:
      cribl.leader: tcp://token@leader:4200
      extraLabels:
        environment: production
        team: platform
        custom-label: custom-value
    template: deployment.yaml
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels.team
          value: platform
      - equal:
          path: metadata.labels.custom-label
          value: custom-value

  - it: Should add extra labels to service
    set:
      cribl.leader: tcp://token@leader:4200
      extraLabels:
        environment: staging
        owner: data-team
    template: service.yaml
    asserts:
      - equal:
          path: metadata.labels.environment
          value: staging
      - equal:
          path: metadata.labels.owner
          value: data-team

  - it: Should add extra labels to service account
    set:
      cribl.leader: tcp://token@leader:4200
      extraLabels:
        environment: dev
        app-version: v2
    template: serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.labels.environment
          value: dev
      - equal:
          path: metadata.labels.app-version
          value: v2

  - it: Should add custom pod labels through deployment template
    set:
      cribl.leader: tcp://token@leader:4200
      labels:
        pod-label: pod-value
        version: "1.2.3"
    template: deployment.yaml
    asserts:
      - equal:
          path: spec.template.metadata.labels.pod-label
          value: pod-value
      - equal:
          path: spec.template.metadata.labels.version
          value: "1.2.3"

  - it: Should support numeric labels
    set:
      cribl.leader: tcp://token@leader:4200
      extraLabels:
        build-number: "12345"
    template: deployment.yaml
    asserts:
      - equal:
          path: metadata.labels.build-number
          value: "12345"

  - it: Should have correct selector labels on service
    set:
      cribl.leader: tcp://token@leader:4200
    template: service.yaml
    release:
      name: my-release
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: outpost
      - equal:
          path: spec.selector["app.kubernetes.io/instance"]
          value: my-release

