suite: Secret
templates:
  - secret.yaml
  - deployment.yaml
tests:
  - it: Should create secret with CRIBL_DIST_LEADER_URL from cribl.leader
    set:
      cribl.leader: tcp://mytoken@example:4200/?group=outpost&tag=outpost
    template: secret.yaml
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: stringData.CRIBL_DIST_LEADER_URL
          value: tcp://mytoken@example:4200/?group=outpost&tag=outpost
      - notExists:
          path: stringData.CRIBL_BOOTSTRAP

  - it: Should create secret with both CRIBL_DIST_LEADER_URL and CRIBL_BOOTSTRAP
    set:
      cribl:
        leader: tcp://mytoken@example:4200/?group=outpost&tag=outpost
        config: |
          cribl/local.yml:
            foo: bar
    template: secret.yaml
    asserts:
      - equal:
          path: stringData.CRIBL_DIST_LEADER_URL
          value: tcp://mytoken@example:4200/?group=outpost&tag=outpost
      - equal:
          path: stringData.CRIBL_BOOTSTRAP
          value: |
            cribl/local.yml:
              foo: bar

  - it: Should not create secret when using existingSecretForLeader
    set:
      cribl:
        existingSecretForLeader: my-existing-secret
    template: secret.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: Should not create secret when using both existingSecretForLeader and existingSecretForConfig
    set:
      cribl:
        existingSecretForLeader: my-leader-secret
        existingSecretForConfig: my-config-secret
    template: secret.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: Should reference default secret in deployment
    set:
      cribl.leader: tcp://mytoken@example:4200
    template: deployment.yaml
    release:
      name: test-release
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CRIBL_DIST_LEADER_URL
            valueFrom:
              secretKeyRef:
                name: test-release-outpost-cribl-settings
                key: CRIBL_DIST_LEADER_URL

  - it: Should reference existing secret for leader in deployment
    set:
      cribl.existingSecretForLeader: my-leader-secret
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CRIBL_DIST_LEADER_URL
            valueFrom:
              secretKeyRef:
                name: my-leader-secret
                key: CRIBL_DIST_LEADER_URL

  - it: Should reference default secret for config in deployment
    set:
      cribl:
        leader: tcp://mytoken@example:4200
        config: |
          cribl/local.yml:
            foo: bar
    template: deployment.yaml
    release:
      name: test-release
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CRIBL_BOOTSTRAP
            valueFrom:
              secretKeyRef:
                name: test-release-outpost-cribl-settings
                key: CRIBL_BOOTSTRAP

  - it: Should reference existing secret for config in deployment
    set:
      cribl:
        leader: tcp://mytoken@example:4200
        existingSecretForConfig: my-config-secret
        config: |
          cribl/local.yml:
            foo: bar
    template: deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CRIBL_BOOTSTRAP
            valueFrom:
              secretKeyRef:
                name: my-config-secret
                key: CRIBL_BOOTSTRAP

  - it: Should not add CRIBL_BOOTSTRAP env when config is not set
    set:
      cribl.leader: tcp://mytoken@example:4200
    template: deployment.yaml
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: CRIBL_BOOTSTRAP

  - it: Should have correct secret name and metadata
    set:
      cribl.leader: tcp://mytoken@example:4200
    template: secret.yaml
    release:
      name: my-outpost
    asserts:
      - equal:
          path: metadata.name
          value: my-outpost-cribl-settings
      - equal:
          path: kind
          value: Secret
      - equal:
          path: apiVersion
          value: v1

  - it: Should support TLS leader URL
    set:
      cribl.leader: tls://mytoken@example:4200/?group=outpost&tag=outpost&tls.rejectUnauthorized=1
    template: secret.yaml
    asserts:
      - equal:
          path: stringData.CRIBL_DIST_LEADER_URL
          value: tls://mytoken@example:4200/?group=outpost&tag=outpost&tls.rejectUnauthorized=1

