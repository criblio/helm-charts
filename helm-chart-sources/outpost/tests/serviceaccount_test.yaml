suite: Service Account
templates:
  - serviceaccount.yaml
  - deployment.yaml

tests:
  - it: Should create a ServiceAccount and define serviceAccountName by default
    set:
      cribl.leader: tcp://token@leader:4200
    asserts:
      - template: serviceaccount.yaml
        hasDocuments:
          count: 1
      - template: deployment.yaml
        equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-outpost

  - it: Should not create a ServiceAccount or define serviceAccountName if set explicitly to false
    set:
      cribl.leader: tcp://token@leader:4200
      serviceAccount:
        create: false
    asserts:
      - template: serviceaccount.yaml
        hasDocuments:
          count: 0
      - template: deployment.yaml
        notExists:
          path: spec.template.spec.serviceAccountName

  - it: Should use default name if create=true and name is not set
    set:
      cribl.leader: tcp://token@leader:4200
      serviceAccount:
        create: true
    release:
      name: my-release
    asserts:
      - template: serviceaccount.yaml
        equal:
          path: metadata.name
          value: my-release-outpost
      - template: deployment.yaml
        equal:
          path: spec.template.spec.serviceAccountName
          value: my-release-outpost

  - it: Should use correct name in deployment if create=false and name is set
    set:
      cribl.leader: tcp://token@leader:4200
      serviceAccount:
        create: false
        name: custom-sa-name
    asserts:
      - template: serviceaccount.yaml
        hasDocuments:
          count: 0
      - template: deployment.yaml
        equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa-name

  - it: Should use the provided name if create=true and name is set
    set:
      cribl.leader: tcp://token@leader:4200
      serviceAccount:
        create: true
        name: custom-sa-name
    asserts:
      - template: serviceaccount.yaml
        equal:
          path: metadata.name
          value: custom-sa-name
      - template: deployment.yaml
        equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa-name

  - it: Should add annotations to the service account
    set:
      cribl.leader: tcp://token@leader:4200
      serviceAccount:
        create: true
        annotations:
          eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-role
          custom-annotation: custom-value
    template: serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/my-role
      - equal:
          path: metadata.annotations.custom-annotation
          value: custom-value

  - it: Should have correct labels on service account
    set:
      cribl.leader: tcp://token@leader:4200
      serviceAccount:
        create: true
    release:
      name: test-release
    template: serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: outpost
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-release

